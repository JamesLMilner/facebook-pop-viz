    <doctype HTML>
<html>
<head>
    <style>
        html, body, #map {
            height: 100%;
            width: 100%;
            background-color: black;
            padding: 0px;
            margin: 0px;
        }
    </style>
</head>
<body>
<script src="../src/node_modules/geotiff/dist/geotiff.min.js"></script>
<script src="../src/node_modules/plotty/dist/plotty.min.js"></script>
<script src="../src/node_modules/openlayers/dist/ol-debug.js"></script>
<!-- <canvas id="plot"></canvas> -->
<div id="map"></div>
<script>
    console.log("Starting script");
    var url = "/data/hrsl_mwi_downsample.tif"
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.responseType = 'arraybuffer';
    xhr.onload = function(e) {
      console.log("Loading GeoTIFF...")
      var tiff = GeoTIFF.parse(this.response);
      var image = tiff.getImage();
      var metadata = image.getGDALMetadata()

      var extent = [
                    metadata.minX, metadata.minY,
                    metadata.maxX, metadata.maxY
                   ]  //[15.05, 47.75, 15.40, 47.95]
      console.log(extent);
      var plot;
      var map = null;
      var canvas;

      //var rasterInput = {window: [0, 0, image.getWidth(), image.getHeight()], samples: [0]}
      image.readRasters({}, function(rasters) {
        var raster = rasters[0]
        canvas = document.createElement("canvas");
        plot = new plotty.plot({
          canvas: canvas,
          data: raster,
          width: image.getWidth(),
          height: image.getHeight(),
          domain: [0, 12],
          colorScale: "copper"
        });
        plot.setClamp(true,true);
        plot.setNoDataValue(0);

        plot.render();
        var projection = ol.proj.get('EPSG:4326');
        var centerPos = [parseFloat(extent[0]).toFixed(5), parseFloat(extent[1]).toFixed(5) ];
        console.log(centerPos)
        var attribution = new ol.Attribution({
          html: 'Tiles &copy; <a href="http://services.arcgisonline.com/ArcGIS/' +
              'rest/servicesWorld_Light_Gray_Base/MapServer">ArcGIS</a>'
        });

        canvas.getContext("webgl").fillStyle = 'rgba(255, 255, 255, 0)';
        mapLayers = [
          new ol.layer.Tile({
              source: new ol.source.XYZ({
                attributions: [attribution],
                url: 'http://server.arcgisonline.com/ArcGIS/rest/services/' +
                  '/Canvas/World_Dark_Gray_Reference/MapServer/tile/{z}/{y}/{x}'
              }),
              opacity: 1
          }),
          new ol.layer.Tile({
              source: new ol.source.XYZ({
                attributions: [attribution],
                url: 'http://server.arcgisonline.com/ArcGIS/rest/services/' +
                  '/Canvas/World_Dark_Gray_Base/MapServer/tile/{z}/{y}/{x}'
              }),
              opacity: 0.2
          }),
          new ol.layer.Image({
            source: new ol.source.ImageStatic({
              url: canvas.toDataURL("image/png"),
              imageExtent: extent
            }),
            extent: extent,
            opacity: 1
          })
        ]

        var zIndex = 3
        mapLayers.forEach(function(layer){
            layer.setZIndex(zIndex--);
        });

        map = new ol.Map({
          target: document.getElementById("map"),
          controls: ol.control.defaults({attribution: false})   ,
          layers: mapLayers,
          view: new ol.View({
            center: [0,0],
            projection: projection,
            zoom: 5,
            // extent: extent
            })
        });

      });

    }
    xhr.send();

</script>
</body>
</html>
